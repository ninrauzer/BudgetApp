<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n - BudgetApp</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1><i data-lucide="wallet" style="width: 28px; height: 28px; vertical-align: middle;"></i> BudgetApp <span style="font-size: 0.875rem; font-weight: 400; opacity: 0.8;">| Tu Finanzas Personales</span></h1>
            <nav class="nav">
                <a href="/" class="nav-link"><i data-lucide="layout-dashboard" style="width: 16px; height: 16px; vertical-align: middle;"></i> Dashboard</a>
                <a href="/transactions" class="nav-link"><i data-lucide="credit-card" style="width: 16px; height: 16px; vertical-align: middle;"></i> Transacciones</a>
                <a href="/budget" class="nav-link"><i data-lucide="trending-up" style="width: 16px; height: 16px; vertical-align: middle;"></i> Presupuesto</a>
                <a href="/analysis" class="nav-link"><i data-lucide="bar-chart-3" style="width: 16px; height: 16px; vertical-align: middle;"></i> An√°lisis</a>
                <a href="/settings" class="nav-link active"><i data-lucide="settings" style="width: 16px; height: 16px; vertical-align: middle;"></i> Configuraci√≥n</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1><i data-lucide="settings" style="width: 28px; height: 28px; vertical-align: middle;"></i> Configuraci√≥n</h1>
            <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                Personaliza tu experiencia
            </p>
        </div>

        <!-- Tema -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="palette" style="width: 18px; height: 18px; vertical-align: middle;"></i> Apariencia</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Tema</label>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <button class="theme-btn" data-theme="light" id="theme-light">
                            <div class="theme-icon"><i data-lucide="sun" style="width: 24px; height: 24px;"></i></div>
                            <div class="theme-name">Claro</div>
                        </button>
                        <button class="theme-btn" data-theme="dark" id="theme-dark">
                            <div class="theme-icon"><i data-lucide="moon" style="width: 24px; height: 24px;"></i></div>
                            <div class="theme-name">Oscuro</div>
                        </button>
                        <button class="theme-btn" data-theme="auto" id="theme-auto">
                            <div class="theme-icon"><i data-lucide="laptop" style="width: 24px; height: 24px;"></i></div>
                            <div class="theme-name">Autom√°tico</div>
                        </button>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.75rem;">
                        El modo autom√°tico se ajusta seg√∫n la configuraci√≥n de tu sistema
                    </p>
                </div>
            </div>
        </div>

        <!-- Preferencias -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="briefcase" style="width: 18px; height: 18px; vertical-align: middle;"></i> Preferencias</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Moneda</label>
                    <select class="form-control" id="currency-select">
                        <option value="PEN" selected>Sol Peruano (S/)</option>
                        <option value="USD">D√≥lar Americano ($)</option>
                        <option value="EUR">Euro (‚Ç¨)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Idioma</label>
                    <select class="form-control" id="language-select">
                        <option value="es" selected>Espa√±ol</option>
                        <option value="en">English</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="notifications-check" checked>
                        <span>Activar notificaciones de presupuesto</span>
                    </label>
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.25rem; margin-left: 1.5rem;">
                        Te notificaremos cuando est√©s cerca de tu l√≠mite de presupuesto
                    </p>
                </div>
            </div>
        </div>

        <!-- Datos -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="database" style="width: 18px; height: 18px; vertical-align: middle;"></i> Datos</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label"><i data-lucide="download" style="width: 16px; height: 16px; vertical-align: middle;"></i> Importar Transacciones desde Excel</label>
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.75rem;">
                        Sube un archivo Excel con tus transacciones. Columnas esperadas: Fecha, Categor√≠a, Monto, Tipo, Descripci√≥n.
                    </p>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        <input type="file" id="excel-file" accept=".xlsx,.xlsm,.xls" style="flex: 1; min-width: 200px;">
                        <select id="account-select" class="form-control" style="width: 200px;">
                            <option value="">Cuenta por defecto...</option>
                        </select>
                        <button class="btn" onclick="importExcel()">
                            üì§ Importar
                        </button>
                        <a href="/api/import/template" class="btn btn-secondary" download>
                            ÔøΩ Descargar Plantilla
                        </a>
                    </div>
                    <div id="import-result" style="margin-top: 1rem; display: none;"></div>
                </div>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);">
                
                <div class="form-group">
                    <label class="form-label"><i data-lucide="trash-2" style="width: 16px; height: 16px; vertical-align: middle;"></i> Gesti√≥n de Datos</label>
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.75rem;">
                        Administra tus datos: carga datos de prueba o limpia todo para empezar de cero.
                    </p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn" onclick="loadDemoData()" style="background: #3b82f6; color: white;">
                            <i data-lucide="database" style="width: 16px; height: 16px; vertical-align: middle;"></i> Cargar Datos Demo
                        </button>
                        <button class="btn" onclick="clearAllData()" style="background: #ef4444; color: white;">
                            <i data-lucide="trash-2" style="width: 16px; height: 16px; vertical-align: middle;"></i> Limpiar Todos los Datos
                        </button>
                    </div>
                    <div id="data-management-result" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>

        <!-- Categor√≠as -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="tag" style="width: 18px; height: 18px; vertical-align: middle;"></i> Categor√≠as</h3>
                <button class="btn btn-primary" onclick="openCategoryModal()">
                    <i data-lucide="plus" style="width: 16px; height: 16px; vertical-align: middle;"></i> Nueva Categor√≠a
                </button>
            </div>
            <div class="card-body">
                <div id="categories-list">
                    <p style="text-align: center; color: var(--text-secondary);">Cargando categor√≠as...</p>
                </div>
            </div>
        </div>

        <!-- Cuentas -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="credit-card" style="width: 18px; height: 18px; vertical-align: middle;"></i> Cuentas</h3>
                <button class="btn btn-primary" onclick="openAccountModal()">
                    <i data-lucide="plus" style="width: 16px; height: 16px; vertical-align: middle;"></i> Nueva Cuenta
                </button>
            </div>
            <div class="card-body">
                <div id="accounts-list">
                    <p style="text-align: center; color: var(--text-secondary);">Cargando cuentas...</p>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i data-lucide="info" style="width: 18px; height: 18px; vertical-align: middle;"></i> Acerca de</h3>
            </div>
            <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Versi√≥n</span>
                        <strong>1.0.0 (MVP)</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Base de Datos</span>
                        <strong>SQLite</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Framework</span>
                        <strong>FastAPI + HTMX</strong>
                    </div>
                </div>
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <a href="/docs" target="_blank" class="btn" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <i data-lucide="book-open" style="width: 16px; height: 16px; vertical-align: middle;"></i> Documentaci√≥n API
                        <i data-lucide="external-link" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal CRUD Categor√≠a -->
    <div id="category-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="modal-title"><i data-lucide="plus" style="width: 20px; height: 20px; vertical-align: middle;"></i> Nueva Categor√≠a</h3>
                <button class="close-btn" onclick="closeCategoryModal()">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="category-form">
                    <input type="hidden" id="category-id">
                    
                    <div class="form-group">
                        <label class="form-label">Nombre *</label>
                        <input type="text" id="category-name" class="form-control" placeholder="Ej: Alimentaci√≥n, Salario, etc." required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo *</label>
                        <select id="category-type" class="form-control" required>
                            <option value="">Seleccionar tipo...</option>
                            <option value="income">üí∞ Ingreso</option>
                            <option value="expense">üí∏ Gasto</option>
                            <option value="saving">üè¶ Ahorro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Icono</label>
                        <input type="hidden" id="category-icon" name="icon">
                        <div id="icon-selector" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.5rem; max-height: 200px; overflow-y: auto; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px;">
                            <!-- Los iconos se llenar√°n din√°micamente -->
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
                            Selecciona un icono para tu categor√≠a
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Color (Opcional)</label>
                        <input type="color" id="category-color" class="form-control" style="height: 40px;">
                    </div>
                    
                    <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                        <button type="button" class="btn" onclick="closeCategoryModal()" style="flex: 1;">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i data-lucide="save" style="width: 16px; height: 16px; vertical-align: middle;"></i> Guardar
                        </button>
                    </div>
                </form>
                
                <!-- Bot√≥n de eliminar (solo en modo edici√≥n) -->
                <div id="delete-section" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn" style="width: 100%; background: var(--danger-light); color: var(--danger-color);" onclick="deleteCategory()">
                        <i data-lucide="trash-2" style="width: 16px; height: 16px; vertical-align: middle;"></i> Eliminar Categor√≠a Permanentemente
                    </button>
                    <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem; text-align: center;">
                        ‚ö†Ô∏è Esto eliminar√° la categor√≠a y todas sus transacciones asociadas
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal CRUD Cuenta -->
    <div id="account-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="account-modal-title"><i data-lucide="plus" style="width: 20px; height: 20px; vertical-align: middle;"></i> Nueva Cuenta</h3>
                <button class="close-btn" onclick="closeAccountModal()">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="account-form">
                    <input type="hidden" id="account-id">
                    
                    <div class="form-group">
                        <label class="form-label">Nombre *</label>
                        <input type="text" id="account-name" class="form-control" placeholder="Ej: Efectivo, BCP, Interbank" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo *</label>
                        <select id="account-type" class="form-control" required>
                            <option value="">Seleccionar tipo...</option>
                            <option value="cash">üíµ Efectivo</option>
                            <option value="bank">üè¶ Cuenta Bancaria</option>
                            <option value="credit_card">üí≥ Tarjeta de Cr√©dito</option>
                            <option value="debit_card">üí≥ Tarjeta de D√©bito</option>
                            <option value="digital_wallet">üì± Billetera Digital</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Saldo Inicial</label>
                        <input type="number" id="account-balance" class="form-control" placeholder="0.00" step="0.01" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Moneda</label>
                        <select id="account-currency" class="form-control">
                            <option value="PEN" selected>PEN (S/)</option>
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (‚Ç¨)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="account-is-active" checked>
                            <span>Cuenta activa</span>
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                        <button type="button" class="btn" onclick="closeAccountModal()" style="flex: 1;">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i data-lucide="save" style="width: 16px; height: 16px; vertical-align: middle;"></i> Guardar
                        </button>
                    </div>
                </form>
                
                <!-- Bot√≥n de eliminar (solo en modo edici√≥n) -->
                <div id="account-delete-section" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn" style="width: 100%; background: var(--danger-light); color: var(--danger-color);" onclick="deleteAccount()">
                        <i data-lucide="trash-2" style="width: 16px; height: 16px; vertical-align: middle;"></i> Eliminar Cuenta Permanentemente
                    </button>
                    <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem; text-align: center;">
                        ‚ö†Ô∏è Esto eliminar√° la cuenta y todas sus transacciones asociadas
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Cargar Lucide primero -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        // Sistema de temas
        const themeButtons = document.querySelectorAll('.theme-btn');
        const html = document.documentElement;

        // Cargar tema guardado
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);

        // Event listeners para botones de tema
        themeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const theme = btn.dataset.theme;
                localStorage.setItem('theme', theme);
                applyTheme(theme);
            });
        });

        function applyTheme(theme) {
            // Remover clase activa de todos los botones
            themeButtons.forEach(btn => btn.classList.remove('active'));
            
            // Activar bot√≥n seleccionado
            document.getElementById(`theme-${theme}`).classList.add('active');
            
            // Aplicar tema
            if (theme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                html.setAttribute('data-theme', theme);
            }
        }

        // Escuchar cambios en preferencias del sistema
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'auto') {
                html.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            }
        });

        // Guardar otras preferencias (simulado)
        document.getElementById('currency-select').addEventListener('change', (e) => {
            localStorage.setItem('currency', e.target.value);
            console.log('Moneda guardada:', e.target.value);
        });

        document.getElementById('language-select').addEventListener('change', (e) => {
            localStorage.setItem('language', e.target.value);
            console.log('Idioma guardado:', e.target.value);
        });

        document.getElementById('notifications-check').addEventListener('change', (e) => {
            localStorage.setItem('notifications', e.target.checked);
            console.log('Notificaciones:', e.target.checked);
        });

        // Cargar preferencias guardadas
        const savedCurrency = localStorage.getItem('currency');
        if (savedCurrency) document.getElementById('currency-select').value = savedCurrency;

        const savedLanguage = localStorage.getItem('language');
        if (savedLanguage) document.getElementById('language-select').value = savedLanguage;

        const savedNotifications = localStorage.getItem('notifications');
        if (savedNotifications !== null) {
            document.getElementById('notifications-check').checked = savedNotifications === 'true';
        }
        
        // Cargar cuentas para selector de importaci√≥n
        fetch('/api/accounts')
            .then(res => res.json())
            .then(accounts => {
                const select = document.getElementById('account-select');
                accounts.forEach(acc => {
                    if (acc.is_active) {
                        const option = document.createElement('option');
                        option.value = acc.id;
                        option.textContent = `${acc.name} (S/ ${acc.balance.toFixed(2)})`;
                        select.appendChild(option);
                    }
                });
            });
        
        // Funci√≥n de importaci√≥n de Excel
        async function importExcel() {
            const fileInput = document.getElementById('excel-file');
            const accountSelect = document.getElementById('account-select');
            const resultDiv = document.getElementById('import-result');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Por favor selecciona un archivo Excel');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            if (accountSelect.value) {
                formData.append('default_account_id', accountSelect.value);
            }
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p style="color: var(--text-secondary);">‚è≥ Procesando archivo...</p>';
            
            try {
                const response = await fetch('/api/import/excel', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    let html = '<div style="padding: 1rem; border-radius: 8px; background: var(--success-light);">';
                    html += `<h4 style="color: var(--success-color); margin: 0 0 0.5rem 0;">‚úÖ Importaci√≥n Completada</h4>`;
                    html += `<p><strong>${result.success_count}</strong> transacciones importadas correctamente</p>`;
                    
                    if (result.error_count > 0) {
                        html += `<p style="color: var(--danger-color);"><strong>${result.error_count}</strong> errores encontrados</p>`;
                        html += '<details><summary style="cursor: pointer;">Ver errores</summary><ul>';
                        result.errors.forEach(err => {
                            html += `<li>Fila ${err.row}: ${err.message}</li>`;
                        });
                        html += '</ul></details>';
                    }
                    
                    if (result.warnings && result.warnings.length > 0) {
                        html += '<details><summary style="cursor: pointer;">Ver advertencias</summary><ul>';
                        result.warnings.forEach(warn => {
                            html += `<li>${warn}</li>`;
                        });
                        html += '</ul></details>';
                    }
                    
                    html += '</div>';
                    resultDiv.innerHTML = html;
                    
                    // Limpiar input
                    fileInput.value = '';
                } else {
                    resultDiv.innerHTML = `<div style="padding: 1rem; border-radius: 8px; background: var(--danger-light); color: var(--danger-color);">
                        <h4 style="margin: 0 0 0.5rem 0;">‚ùå Error en la Importaci√≥n</h4>
                        <p>${result.detail || 'Error desconocido'}</p>
                    </div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="padding: 1rem; border-radius: 8px; background: var(--danger-light); color: var(--danger-color);">
                    <h4 style="margin: 0 0 0.5rem 0;"><i data-lucide="x-circle" style="width: 16px; height: 16px; vertical-align: middle;"></i> Error</h4>
                    <p>${error.message}</p>
                </div>`;
                lucide.createIcons();
            }
        }
        
        // Cargar datos demo
        async function loadDemoData() {
            if (!confirm('¬øCargar datos de demostraci√≥n? Esto crear√° transacciones y presupuestos de ejemplo.')) {
                return;
            }
            
            const resultDiv = document.getElementById('data-management-result');
            resultDiv.innerHTML = '<p style="color: var(--text-secondary);"><i data-lucide="loader" class="spin" style="width: 16px; height: 16px; vertical-align: middle;"></i> Cargando datos...</p>';
            lucide.createIcons();
            
            try {
                const response = await fetch('/api/data/load-demo', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<div style="padding: 1rem; border-radius: 8px; background: #d1fae5; color: #065f46;">
                        <h4 style="margin: 0 0 0.5rem 0;"><i data-lucide="check-circle" style="width: 16px; height: 16px; vertical-align: middle;"></i> Datos Cargados</h4>
                        <p style="margin: 0;">${result.transactions_created} transacciones y ${result.budgets_created} presupuestos creados.</p>
                    </div>`;
                } else {
                    resultDiv.innerHTML = `<div style="padding: 1rem; border-radius: 8px; background: var(--danger-light); color: var(--danger-color);">
                        <h4 style="margin: 0 0 0.5rem 0;"><i data-lucide="x-circle" style="width: 16px; height: 16px; vertical-align: middle;"></i> Error</h4>
                        <p>${result.detail || 'Error desconocido'}</p>
                    </div>`;
                }
                lucide.createIcons();
            } catch (error) {
                resultDiv.innerHTML = `<div style="padding: 1rem; border-radius: 8px; background: var(--danger-light); color: var(--danger-color);">
                    <h4 style="margin: 0 0 0.5rem 0;"><i data-lucide="x-circle" style="width: 16px; height: 16px; vertical-align: middle;"></i> Error</h4>
                    <p>${error.message}</p>
                </div>`;
                lucide.createIcons();
            }
        }
        
        // Limpiar todos los datos
        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto eliminar√° TODAS las transacciones y presupuestos. Esta acci√≥n NO se puede deshacer.')) {
                return;
            }
            
            if (!confirm('üö® √öLTIMA CONFIRMACI√ìN: ¬øRealmente quieres borrar todos tus datos?')) {
                return;
            }
            
            const resultDiv = document.getElementById('data-management-result');
            resultDiv.innerHTML = '<p style="color: var(--text-secondary);"><i data-lucide="loader" class="spin" style="width: 16px; height: 16px; vertical-align: middle;"></i> Eliminando datos...</p>';
            lucide.createIcons();
            
            try {
                const response = await fetch('/api/data/clear-all', {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<div style="padding: 1rem; border-radius: 8px; background: #d1fae5; color: #065f46;">
                        <h4 style="margin: 0 0 0.5rem 0;"><i data-lucide="check-circle" style="width: 16px; height: 16px; vertical-align: middle;"></i> Datos Eliminados</h4>
                        <p style="margin: 0;">${result.transactions_deleted} transacciones y ${result.budgets_deleted} presupuestos eliminados.</p>
                    </div>`;
                } else {
                    resultDiv.innerHTML = `<div style="padding: 1rem; border-radius: 8px; background: var(--danger-light); color: var(--danger-color);">
                        <h4 style="margin: 0 0 0.5rem 0;"><i data-lucide="x-circle" style="width: 16px; height: 16px; vertical-align: middle;"></i> Error</h4>
                        <p>${result.detail || 'Error desconocido'}</p>
                    </div>`;
                }
                lucide.createIcons();
            } catch (error) {
                resultDiv.innerHTML = `<div style="padding: 1rem; border-radius: 8px; background: var(--danger-light); color: var(--danger-color);">
                    <h4 style="margin: 0 0 0.5rem 0;"><i data-lucide="x-circle" style="width: 16px; height: 16px; vertical-align: middle;"></i> Error</h4>
                    <p>${error.message}</p>
                </div>`;
                lucide.createIcons();
            }
        }
        
        // Cargar lista de categor√≠as
        async function loadCategories() {
            const listDiv = document.getElementById('categories-list');
            listDiv.innerHTML = '<p style="text-align: center; color: var(--text-secondary);"><i data-lucide="loader" class="spin"></i> Cargando...</p>';
            lucide.createIcons();
            
            try {
                const response = await fetch('/api/categories?include_inactive=true');
                if (!response.ok) throw new Error('Error en la respuesta del servidor');
                
                const categories = await response.json();
                
                if (categories.length === 0) {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>No hay categor√≠as creadas</p>
                            <button class="btn btn-primary" onclick="openCategoryModal()" style="margin-top: 1rem;">
                                <i data-lucide="plus" style="width: 16px; height: 16px; vertical-align: middle;"></i> Crear Primera Categor√≠a
                            </button>
                        </div>`;
                    lucide.createIcons();
                    return;
                }
                
                // Crear tabla
                let html = `
                    <div style="overflow-x: auto;">
                        <table class="data-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="text-align: left; padding: 12px; background: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">Icono</th>
                                    <th style="text-align: left; padding: 12px; background: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">Nombre</th>
                                    <th style="text-align: left; padding: 12px; background: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">Tipo</th>
                                    <th style="text-align: center; padding: 12px; background: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">Estado</th>
                                    <th style="text-align: center; padding: 12px; background: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                // Ordenar: activos primero, luego por tipo y nombre
                categories.sort((a, b) => {
                    if (a.is_active !== b.is_active) return b.is_active - a.is_active;
                    if (a.type !== b.type) return a.type.localeCompare(b.type);
                    return a.name.localeCompare(b.name);
                });
                
                const typeIcons = {
                    income: '<i data-lucide="trending-up" style="width: 16px; height: 16px; vertical-align: middle; color: #059669;"></i>',
                    expense: '<i data-lucide="trending-down" style="width: 16px; height: 16px; vertical-align: middle; color: #dc2626;"></i>',
                    saving: '<i data-lucide="piggy-bank" style="width: 16px; height: 16px; vertical-align: middle; color: #2563eb;"></i>'
                };
                
                const typeLabels = {
                    income: 'Ingreso',
                    expense: 'Gasto',
                    saving: 'Ahorro'
                };
                
                const typeColors = {
                    income: '#059669',
                    expense: '#dc2626',
                    saving: '#2563eb'
                };
                
                categories.forEach(cat => {
                    const opacity = cat.is_active ? '1' : '0.5';
                    const iconColor = typeColors[cat.type];
                    const iconName = cat.icon || 'circle';
                    
                    html += `
                        <tr style="opacity: ${opacity}; transition: all 0.2s; border-bottom: 1px solid var(--border-color);" 
                            onmouseover="this.style.background='var(--bg-secondary)'" 
                            onmouseout="this.style.background='transparent'">
                            <td style="padding: 12px;">
                                <i data-lucide="${iconName}" style="width: 20px; height: 20px; color: ${iconColor};"></i>
                            </td>
                            <td style="padding: 12px;">
                                <strong>${cat.name}</strong>
                            </td>
                            <td style="padding: 12px;">
                                ${typeIcons[cat.type]} <span style="color: ${iconColor};">${typeLabels[cat.type]}</span>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                ${cat.is_active 
                                    ? '<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; background: #d1fae5; color: #065f46; border-radius: 12px; font-size: 0.75rem; font-weight: 600;"><i data-lucide="check-circle" style="width: 12px; height: 12px;"></i> Activa</span>'
                                    : '<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; background: #e2e8f0; color: #475569; border-radius: 12px; font-size: 0.75rem; font-weight: 600;"><i data-lucide="archive" style="width: 12px; height: 12px;"></i> Inactiva</span>'
                                }
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <div style="display: inline-flex; gap: 8px;">
                                    <button onclick="editCategory(${cat.id})" 
                                            class="btn-icon" 
                                            title="Editar"
                                            style="padding: 6px 12px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s;">
                                        <i data-lucide="edit-3" style="width: 14px; height: 14px;"></i>
                                        <span style="font-size: 0.875rem;">Editar</span>
                                    </button>
                                    <button onclick="toggleCategoryActive(${cat.id}, ${cat.is_active})" 
                                            class="btn-icon" 
                                            title="${cat.is_active ? 'Desactivar' : 'Activar'}"
                                            style="padding: 6px 12px; background: ${cat.is_active ? '#f59e0b' : '#10b981'}; color: white; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s;">
                                        <i data-lucide="${cat.is_active ? 'eye-off' : 'eye'}" style="width: 14px; height: 14px;"></i>
                                        <span style="font-size: 0.875rem;">${cat.is_active ? 'Desactivar' : 'Activar'}</span>
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 1rem; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 0.875rem; color: var(--text-secondary);">
                        <i data-lucide="info" style="width: 14px; height: 14px; vertical-align: middle;"></i> 
                        Total: ${categories.length} categor√≠as (${categories.filter(c => c.is_active).length} activas, ${categories.filter(c => !c.is_active).length} inactivas)
                    </div>`;
                
                listDiv.innerHTML = html;
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error cargando categor√≠as:', error);
                listDiv.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--danger-color);">
                        <i data-lucide="alert-circle" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i>
                        <p><strong>Error al cargar categor√≠as</strong></p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">${error.message}</p>
                        <button class="btn" onclick="loadCategories()" style="margin-top: 1rem;">
                            <i data-lucide="refresh-cw" style="width: 16px; height: 16px; vertical-align: middle;"></i> Reintentar
                        </button>
                    </div>`;
                lucide.createIcons();
            }
        }
        
        async function toggleCategoryActive(id, currentStatus) {
            const action = currentStatus ? 'desactivar' : 'activar';
            
            try {
                const response = await fetch(`/api/categories/${id}/toggle-active`, {
                    method: 'PATCH'
                });
                
                if (response.ok) {
                    loadCategories(); // Recargar lista
                } else {
                    alert('Error al cambiar estado de categor√≠a');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }
        
        function openCategoryModal() {
            document.getElementById('category-modal').style.display = 'flex';
            document.getElementById('modal-title').innerHTML = '<i data-lucide="plus" style="width: 20px; height: 20px; vertical-align: middle;"></i> Nueva Categor√≠a';
            document.getElementById('category-form').reset();
            document.getElementById('category-id').value = '';
            document.getElementById('delete-section').style.display = 'none';
            populateIconSelector();
            lucide.createIcons();
        }
        
        function closeCategoryModal() {
            document.getElementById('category-modal').style.display = 'none';
        }
        
        // Iconos disponibles de Lucide para categor√≠as
        const availableIcons = {
            // Vivienda & Hogar
            'home': 'Casa',
            'building': 'Edificio',
            'key': 'Llave',
            'bed': 'Cama',
            'sofa': 'Sof√°',
            'lamp': 'L√°mpara',
            'drill': 'Taladro',
            
            // Comida & Bebida
            'utensils': 'Cubiertos',
            'coffee': 'Caf√©',
            'pizza': 'Pizza',
            'apple': 'Manzana',
            'wine': 'Vino',
            'ice-cream': 'Helado',
            
            // Transporte
            'car': 'Auto',
            'bus': 'Bus',
            'bike': 'Bicicleta',
            'plane': 'Avi√≥n',
            'train': 'Tren',
            'fuel': 'Combustible',
            
            // Salud & Deporte
            'heart': 'Coraz√≥n',
            'activity': 'Actividad',
            'dumbbell': 'Pesas',
            'stethoscope': 'Estetoscopio',
            'pill': 'Pastilla',
            'thermometer': 'Term√≥metro',
            
            // Educaci√≥n & Trabajo
            'book': 'Libro',
            'graduation-cap': 'Graduaci√≥n',
            'briefcase': 'Malet√≠n',
            'pen-tool': 'Pluma',
            'award': 'Premio',
            
            // Tecnolog√≠a
            'smartphone': 'Tel√©fono',
            'laptop': 'Laptop',
            'monitor': 'Monitor',
            'headphones': 'Aud√≠fonos',
            'wifi': 'WiFi',
            'tv': 'TV',
            
            // Compras & Ropa
            'shopping-bag': 'Bolsa',
            'shopping-cart': 'Carrito',
            'shirt': 'Camisa',
            'watch': 'Reloj',
            'glasses': 'Lentes',
            
            // Entretenimiento
            'film': 'Pel√≠cula',
            'music': 'M√∫sica',
            'gamepad': 'Videojuego',
            'camera': 'C√°mara',
            'palette': 'Paleta',
            'gift': 'Regalo',
            
            // Finanzas
            'dollar-sign': 'Dinero',
            'credit-card': 'Tarjeta',
            'piggy-bank': 'Alcanc√≠a',
            'landmark': 'Banco',
            'wallet': 'Billetera',
            'receipt': 'Recibo',
            
            // Servicios
            'zap': 'Electricidad',
            'droplet': 'Agua',
            'wifi': 'Internet',
            'phone': 'Tel√©fono',
            'mail': 'Correo',
            
            // Mascotas & Naturaleza
            'dog': 'Perro',
            'cat': 'Gato',
            'fish': 'Pez',
            'tree': '√Årbol',
            'flower': 'Flor',
            
            // Otros
            'wrench': 'Herramienta',
            'scissors': 'Tijeras',
            'umbrella': 'Paraguas',
            'sun': 'Sol',
            'moon': 'Luna',
            'star': 'Estrella',
            'sparkles': 'Destellos',
            'tag': 'Etiqueta',
            'box': 'Caja',
            'package': 'Paquete'
        };
        
        function populateIconSelector() {
            const container = document.getElementById('icon-selector');
            const selectedIcon = document.getElementById('category-icon').value || '';
            
            container.innerHTML = '';
            
            for (const [iconName, iconLabel] of Object.entries(availableIcons)) {
                const iconBtn = document.createElement('button');
                iconBtn.type = 'button';
                iconBtn.className = 'icon-option';
                iconBtn.title = iconLabel;
                iconBtn.innerHTML = `<i data-lucide="${iconName}" style="width: 20px; height: 20px;"></i>`;
                iconBtn.style.cssText = `
                    padding: 0.5rem;
                    border: 2px solid ${selectedIcon === iconName ? 'var(--primary-color)' : 'var(--border-color)'};
                    background: ${selectedIcon === iconName ? 'var(--primary-light)' : 'var(--bg-secondary)'};
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s;
                `;
                
                iconBtn.addEventListener('click', function() {
                    // Remover selecci√≥n previa
                    document.querySelectorAll('.icon-option').forEach(btn => {
                        btn.style.border = '2px solid var(--border-color)';
                        btn.style.background = 'var(--bg-secondary)';
                    });
                    
                    // Marcar como seleccionado
                    this.style.border = '2px solid var(--primary-color)';
                    this.style.background = 'var(--primary-light)';
                    
                    // Guardar selecci√≥n
                    document.getElementById('category-icon').value = iconName;
                });
                
                // Efecto hover
                iconBtn.addEventListener('mouseenter', function() {
                    if (this.style.border !== '2px solid var(--primary-color)') {
                        this.style.background = '#f3f4f6';
                    }
                });
                
                iconBtn.addEventListener('mouseleave', function() {
                    if (this.style.border !== '2px solid var(--primary-color)') {
                        this.style.background = 'var(--bg-secondary)';
                    }
                });
                
                container.appendChild(iconBtn);
            }
            
            lucide.createIcons();
        }
        
        function editCategory(id, name, type) {
            // Cargar datos de la categor√≠a
            fetch(`/api/categories/${id}`)
                .then(res => res.json())
                .then(cat => {
                    document.getElementById('category-modal').style.display = 'flex';
                    document.getElementById('modal-title').innerHTML = '<i data-lucide="edit-3" style="width: 20px; height: 20px; vertical-align: middle;"></i> Editar Categor√≠a';
                    document.getElementById('category-id').value = cat.id;
                    document.getElementById('category-name').value = cat.name;
                    document.getElementById('category-type').value = cat.type;
                    document.getElementById('category-icon').value = cat.icon || '';
                    document.getElementById('category-color').value = cat.color || '#000000';
                    document.getElementById('delete-section').style.display = 'block';
                    populateIconSelector();
                    lucide.createIcons();
                })
                .catch(err => {
                    alert('Error al cargar categor√≠a');
                });
        }
        
        // Enviar formulario de categor√≠a
        document.getElementById('category-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('category-id').value;
            const data = {
                name: document.getElementById('category-name').value,
                type: document.getElementById('category-type').value,
                icon: document.getElementById('category-icon').value || null,
                color: document.getElementById('category-color').value || null
            };
            
            try {
                let response;
                if (id) {
                    // Actualizar
                    response = await fetch(`/api/categories/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Crear
                    response = await fetch('/api/categories', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    closeCategoryModal();
                    loadCategories();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'No se pudo guardar la categor√≠a'));
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error.message);
            }
        });
        
        // Eliminar categor√≠a permanentemente
        async function deleteCategory() {
            const id = document.getElementById('category-id').value;
            const name = document.getElementById('category-name').value;
            
            if (!confirm(`‚ö†Ô∏è ¬øEliminar permanentemente "${name}"?\n\nEsto eliminar√° la categor√≠a y TODAS sus transacciones asociadas.\n\nEsta acci√≥n NO se puede deshacer.`)) {
                return;
            }
            
            if (!confirm(`üö® √öLTIMA CONFIRMACI√ìN\n\n¬øRealmente quieres eliminar "${name}" y todas sus transacciones?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/categories/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    closeCategoryModal();
                    loadCategories();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'No se pudo eliminar la categor√≠a'));
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error.message);
            }
        }
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('category-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCategoryModal();
            }
        });
        
        // ==================== CUENTAS ====================
        
        // Cargar lista de cuentas
        async function loadAccounts() {
            const listDiv = document.getElementById('accounts-list');
            
            try {
                const response = await fetch('/api/accounts');
                const accounts = await response.json();
                
                if (accounts.length === 0) {
                    listDiv.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay cuentas</p>';
                    return;
                }
                
                // Agrupar por tipo
                const grouped = {
                    cash: [],
                    bank: [],
                    credit_card: [],
                    debit_card: [],
                    digital_wallet: []
                };
                
                accounts.forEach(acc => {
                    if (grouped[acc.type]) {
                        grouped[acc.type].push(acc);
                    }
                });
                
                const typeLabels = {
                    cash: '<i data-lucide="banknote" style="width: 16px; height: 16px; vertical-align: middle;"></i> Efectivo',
                    bank: '<i data-lucide="landmark" style="width: 16px; height: 16px; vertical-align: middle;"></i> Cuentas Bancarias',
                    credit_card: '<i data-lucide="credit-card" style="width: 16px; height: 16px; vertical-align: middle;"></i> Tarjetas de Cr√©dito',
                    debit_card: '<i data-lucide="credit-card" style="width: 16px; height: 16px; vertical-align: middle;"></i> Tarjetas de D√©bito',
                    digital_wallet: '<i data-lucide="smartphone" style="width: 16px; height: 16px; vertical-align: middle;"></i> Billeteras Digitales'
                };
                
                let html = '';
                for (const [type, accs] of Object.entries(grouped)) {
                    if (accs.length > 0) {
                        html += `<div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.75rem; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary);">${typeLabels[type]}</h4>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">`;
                        
                        accs.forEach(acc => {
                            const opacity = acc.is_active ? '1' : '0.4';
                            const statusBadge = acc.is_active ? '' : '<span style="font-size: 0.75rem; color: #94a3b8;">Inactiva</span>';
                            const balance = acc.balance.toFixed(2);
                            const balanceColor = acc.balance >= 0 ? '#059669' : '#dc2626';
                            
                            html += `<div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; display: flex; justify-content: space-between; align-items: center; opacity: ${opacity};">
                                <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <strong>${acc.name}</strong>
                                        ${statusBadge}
                                    </div>
                                    <span style="font-size: 0.875rem; color: ${balanceColor}; font-weight: 600;">${acc.currency} ${balance}</span>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="editAccount(${acc.id})" 
                                            style="background: none; border: none; cursor: pointer; padding: 0.25rem;"
                                            title="Editar">
                                        <i data-lucide="edit-3" style="width: 16px; height: 16px; color: var(--text-secondary);"></i>
                                    </button>
                                </div>
                            </div>`;
                        });
                        
                        html += '</div></div>';
                    }
                }
                
                listDiv.innerHTML = html;
                lucide.createIcons();
                
            } catch (error) {
                listDiv.innerHTML = '<p style="color: var(--danger-color);">Error al cargar cuentas</p>';
            }
        }
        
        function openAccountModal() {
            document.getElementById('account-modal').style.display = 'flex';
            document.getElementById('account-modal-title').innerHTML = '<i data-lucide="plus" style="width: 20px; height: 20px; vertical-align: middle;"></i> Nueva Cuenta';
            document.getElementById('account-form').reset();
            document.getElementById('account-id').value = '';
            document.getElementById('account-balance').value = '0';
            document.getElementById('account-is-active').checked = true;
            document.getElementById('account-delete-section').style.display = 'none';
            lucide.createIcons();
        }
        
        function closeAccountModal() {
            document.getElementById('account-modal').style.display = 'none';
        }
        
        function editAccount(id) {
            fetch(`/api/accounts/${id}`)
                .then(res => res.json())
                .then(acc => {
                    document.getElementById('account-modal').style.display = 'flex';
                    document.getElementById('account-modal-title').innerHTML = '<i data-lucide="edit-3" style="width: 20px; height: 20px; vertical-align: middle;"></i> Editar Cuenta';
                    document.getElementById('account-id').value = acc.id;
                    document.getElementById('account-name').value = acc.name;
                    document.getElementById('account-type').value = acc.type;
                    document.getElementById('account-balance').value = acc.balance;
                    document.getElementById('account-currency').value = acc.currency;
                    document.getElementById('account-is-active').checked = acc.is_active;
                    document.getElementById('account-delete-section').style.display = 'block';
                    lucide.createIcons();
                })
                .catch(err => {
                    alert('Error al cargar cuenta');
                });
        }
        
        // Enviar formulario de cuenta
        document.getElementById('account-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('account-id').value;
            const data = {
                name: document.getElementById('account-name').value,
                type: document.getElementById('account-type').value,
                balance: parseFloat(document.getElementById('account-balance').value),
                currency: document.getElementById('account-currency').value,
                is_active: document.getElementById('account-is-active').checked
            };
            
            try {
                let response;
                if (id) {
                    // Actualizar
                    response = await fetch(`/api/accounts/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Crear
                    response = await fetch('/api/accounts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    closeAccountModal();
                    loadAccounts();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'No se pudo guardar la cuenta'));
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error.message);
            }
        });
        
        // Eliminar cuenta permanentemente
        async function deleteAccount() {
            const id = document.getElementById('account-id').value;
            const name = document.getElementById('account-name').value;
            
            if (!confirm(`‚ö†Ô∏è ¬øEliminar permanentemente "${name}"?\n\nEsto eliminar√° la cuenta y TODAS sus transacciones asociadas.\n\nEsta acci√≥n NO se puede deshacer.`)) {
                return;
            }
            
            if (!confirm(`üö® √öLTIMA CONFIRMACI√ìN\n\n¬øRealmente quieres eliminar "${name}" y todas sus transacciones?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    closeAccountModal();
                    loadAccounts();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'No se pudo eliminar la cuenta'));
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error.message);
            }
        }
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('account-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAccountModal();
            }
        });
        
        // Cargar categor√≠as y cuentas al iniciar
        loadCategories();
        loadAccounts();
        
        // Inicializar iconos de Lucide
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
    <script>
        // Inicializar iconos de Lucide cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        
        // Inicializar despu√©s de que la ventana cargue completamente
        window.addEventListener('load', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>
