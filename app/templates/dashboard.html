<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BudgetApp - Dashboard Financiero</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/json-enc.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1><i data-lucide="wallet" style="width: 28px; height: 28px; vertical-align: middle;"></i> BudgetApp <span style="font-size: 0.875rem; font-weight: 400; opacity: 0.8;">| Tu Finanzas Personales</span></h1>
            <nav class="nav">
                <a href="/" class="nav-link active"><i data-lucide="layout-dashboard" style="width: 16px; height: 16px; vertical-align: middle;"></i> Dashboard</a>
                <a href="/transactions" class="nav-link"><i data-lucide="credit-card" style="width: 16px; height: 16px; vertical-align: middle;"></i> Transacciones</a>
                <a href="/budget" class="nav-link"><i data-lucide="trending-up" style="width: 16px; height: 16px; vertical-align: middle;"></i> Presupuesto</a>
                <a href="/analysis" class="nav-link"><i data-lucide="bar-chart-3" style="width: 16px; height: 16px; vertical-align: middle;"></i> An√°lisis</a>
                <a href="/settings" class="nav-link"><i data-lucide="settings" style="width: 16px; height: 16px; vertical-align: middle;"></i> Configuraci√≥n</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Selector de Per√≠odo -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìÖ Seleccionar Per√≠odo</h2>
            </div>
            <form id="period-form" class="grid grid-3">
                <div class="form-group">
                    <label class="form-label">üìÜ A√±o</label>
                    <select id="year" class="form-select" 
                            hx-get="/dashboard/summary" 
                            hx-trigger="change"
                            hx-include="#month"
                            hx-target="#dashboard-summary">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">üìÖ Mes</label>
                    <select id="month" class="form-select"
                            hx-get="/dashboard/summary"
                            hx-trigger="change"
                            hx-include="#year"
                            hx-target="#dashboard-summary">
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11" selected>Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-primary" style="width: 100%;"
                            hx-get="/dashboard/summary"
                            hx-include="#year, #month"
                            hx-target="#dashboard-summary">
                        üîÑ Actualizar <span class="htmx-indicator spinner"></span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Resumen Dashboard -->
        <div id="dashboard-summary" 
             hx-get="/dashboard/summary?year=2025&month=11"
             hx-trigger="load">
            <div class="grid grid-3">
                <div class="stat-card income">
                    <div class="stat-icon">üíö</div>
                    <div class="stat-label">Ingresos</div>
                    <div class="stat-value">S/ 0.00</div>
                    <div class="stat-subtitle">üìä Presupuestado: S/ 0.00</div>
                </div>
                <div class="stat-card expense">
                    <div class="stat-icon">üí∏</div>
                    <div class="stat-label">Gastos</div>
                    <div class="stat-value">S/ 0.00</div>
                    <div class="stat-subtitle">üìä Presupuestado: S/ 0.00</div>
                </div>
                <div class="stat-card saving">
                    <div class="stat-icon">üè¶</div>
                    <div class="stat-label">Balance</div>
                    <div class="stat-value">S/ 0.00</div>
                    <div class="stat-subtitle">üí∞ Ahorros: S/ 0.00</div>
                </div>
            </div>
        </div>

        <!-- Transacciones Recientes -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üí≥ Transacciones Recientes</h2>
                <button class="btn btn-primary" onclick="openTransactionModal()">
                    ‚ûï Nueva Transacci√≥n
                </button>
            </div>
            <div id="transactions-list" 
                 hx-get="/transactions/list"
                 hx-trigger="load, transactionAdded from:body">
                <p class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                    <span class="spinner" style="width: 2rem; height: 2rem; margin: 0 auto; display: block;"></span>
                    <br>Cargando transacciones...
                </p>
            </div>
        </div>

        <!-- Resumen por Categor√≠a -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìä Resumen por Categor√≠a</h2>
            </div>
            <div id="category-summary"
                 hx-get="/transactions/category-summary"
                 hx-trigger="load, transactionAdded from:body">
                <p class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                    <span class="spinner" style="width: 2rem; height: 2rem; margin: 0 auto; display: block;"></span>
                    <br>Cargando resumen...
                </p>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Transacci√≥n -->
    <div id="transaction-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; font-weight: 700;">üí∏ Nueva Transacci√≥n</h2>
                <button class="modal-close" onclick="closeTransactionModal()">&times;</button>
            </div>
            <form hx-post="/api/transactions"
                  hx-ext="json-enc"
                  hx-on::after-request="if(event.detail.successful) { closeTransactionModal(); htmx.trigger('body', 'transactionAdded'); }">
                <div class="form-group">
                    <label class="form-label">üíº Tipo de Transacci√≥n</label>
                    <select id="transaction-type" name="type" class="form-select" required
                            hx-get="/categories/by-type"
                            hx-target="#category-select"
                            hx-include="this"
                            hx-trigger="change">
                        <option value="income">üíö Ingreso</option>
                        <option value="expense" selected>üí∏ Gasto</option>
                        <option value="saving">üè¶ Ahorro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">üè∑Ô∏è Categor√≠a</label>
                    <select id="category-select" name="category_id" class="form-select" required
                            hx-get="/categories/by-type?type=expense"
                            hx-trigger="load"
                            hx-swap="innerHTML">
                        <option value="">Cargando categor√≠as...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">üí≥ Cuenta</label>
                    <select id="account-select" name="account_id" class="form-select" required
                            hx-get="/accounts/select"
                            hx-trigger="load"
                            hx-swap="innerHTML">
                        <option value="">Cargando cuentas...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">üí∞ Monto</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="number" name="amount" step="0.01" class="form-input" required placeholder="0.00" style="flex: 1;">
                        <select name="currency" class="form-select" style="width: 100px;" onchange="updateExchangeRateDisplay(this)">
                            <option value="PEN">S/</option>
                            <option value="USD">$</option>
                        </select>
                    </div>
                    <div id="exchange-rate-info" style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem; display: none;">
                        <span id="exchange-rate-text"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">üìÖ Fecha</label>
                    <input type="date" name="date" class="form-input" required onchange="updateExchangeRateDisplay()">
                </div>
                <script>
                    // Establecer fecha actual por defecto
                    document.addEventListener('DOMContentLoaded', function() {
                        const today = new Date().toISOString().split('T')[0];
                        document.querySelector('input[name="date"]').value = today;
                    });
                    
                    // Mostrar tipo de cambio cuando se selecciona USD
                    async function updateExchangeRateDisplay(selectElement) {
                        const currencySelect = document.querySelector('select[name="currency"]');
                        const dateInput = document.querySelector('input[name="date"]');
                        const exchangeRateInfo = document.getElementById('exchange-rate-info');
                        const exchangeRateText = document.getElementById('exchange-rate-text');
                        const amountInput = document.querySelector('input[name="amount"]');
                        
                        if (currencySelect.value === 'USD' && dateInput.value) {
                            exchangeRateInfo.style.display = 'block';
                            exchangeRateText.textContent = '‚è≥ Consultando tipo de cambio BCRP...';
                            
                            try {
                                // Fetch exchange rate from BCRP via our backend
                                const response = await fetch(`/api/exchange-rate?date=${dateInput.value}`);
                                const data = await response.json();
                                
                                if (data.rate) {
                                    exchangeRateText.innerHTML = `üí± Tipo de cambio: S/ ${data.rate.toFixed(4)} por d√≥lar`;
                                    
                                    // Show conversion if amount is entered
                                    if (amountInput.value) {
                                        const converted = (parseFloat(amountInput.value) * data.rate).toFixed(2);
                                        exchangeRateText.innerHTML += ` <strong>(‚âà S/ ${converted})</strong>`;
                                    }
                                } else {
                                    exchangeRateText.textContent = '‚ö†Ô∏è No se pudo obtener el tipo de cambio';
                                }
                            } catch (error) {
                                exchangeRateText.textContent = '‚ùå Error al consultar tipo de cambio';
                            }
                        } else {
                            exchangeRateInfo.style.display = 'none';
                        }
                    }
                    
                    // Update conversion when amount changes
                    document.addEventListener('DOMContentLoaded', function() {
                        const amountInput = document.querySelector('input[name="amount"]');
                        amountInput.addEventListener('input', function() {
                            updateExchangeRateDisplay();
                        });
                    });
                </script>
                <div class="form-group">
                    <label class="form-label">üìù Descripci√≥n</label>
                    <input type="text" name="description" class="form-input" placeholder="Opcional">
                </div>
                <div class="form-group">
                    <label class="form-label">‚úÖ Estado</label>
                    <select name="status" class="form-select">
                        <option value="completed" selected>‚úÖ Completado</option>
                        <option value="pending">‚è≥ Pendiente</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="closeTransactionModal()" style="background: #e2e8f0; color: #475569;">‚ùå Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openTransactionModal() {
            document.getElementById('transaction-modal').classList.add('active');
        }
        
        function closeTransactionModal() {
            document.getElementById('transaction-modal').classList.remove('active');
            const form = document.querySelector('#transaction-modal form');
            form.reset();
            // Resetear fecha a hoy
            const today = new Date().toISOString().split('T')[0];
            form.querySelector('input[name="date"]').value = today;
        }

        // Cerrar modal al hacer click fuera
        document.getElementById('transaction-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTransactionModal();
            }
        });

        // Sistema de temas
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            
            if (savedTheme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                html.setAttribute('data-theme', savedTheme);
            }
            
            // Escuchar cambios en preferencias del sistema
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (localStorage.getItem('theme') === 'auto') {
                    html.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                }
            });
        })();
    </script>
    <script>
        // Inicializar iconos de Lucide cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
        
        // Re-inicializar iconos despu√©s de cambios HTMX
        document.body.addEventListener('htmx:afterSwap', function() {
            lucide.createIcons();
        });
        
        document.body.addEventListener('htmx:afterSettle', function() {
            lucide.createIcons();
        });
    </script>
</body>
</html>
