<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BudgetApp - Transacciones</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/json-enc.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .btn-sm {
            padding: 0.4rem 0.6rem;
            font-size: 0.875rem;
            min-width: auto;
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        td .btn {
            margin-right: 0.25rem;
        }
        
        /* Quick Add Row */
        .quick-add-row {
            background: #f0f9ff !important;
            border-bottom: 2px solid var(--primary-color) !important;
        }
        
        .quick-add-row td {
            padding: 0.5rem !important;
        }
        
        .quick-input,
        .quick-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            color: var(--text-primary);
        }
        
        .quick-input:focus,
        .quick-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        
        /* Quick Add Panel */
        .quick-add-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--card-bg);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .quick-add-panel.active {
            right: 0;
        }
        
        .quick-add-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            background: linear-gradient(135deg, var(--primary-color) 0%, #5b4cc7 100%);
            color: white;
        }
        
        .quick-add-form {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .form-group-compact {
            margin-bottom: 1rem;
        }
        
        .form-label-compact {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }
        
        .form-input-compact,
        .form-select-compact {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        .form-input-compact:focus,
        .form-select-compact:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .btn-icon {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 0.4rem;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Overlay para cerrar panel */
        .quick-add-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .quick-add-overlay.active {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1><i data-lucide="wallet" style="width: 28px; height: 28px; vertical-align: middle;"></i> BudgetApp <span style="font-size: 0.875rem; font-weight: 400; opacity: 0.8;">| Tu Finanzas Personales</span></h1>
            <nav class="nav">
                <a href="/" class="nav-link"><i data-lucide="layout-dashboard" style="width: 16px; height: 16px; vertical-align: middle;"></i> Dashboard</a>
                <a href="/transactions" class="nav-link active"><i data-lucide="credit-card" style="width: 16px; height: 16px; vertical-align: middle;"></i> Transacciones</a>
                <a href="/budget" class="nav-link"><i data-lucide="trending-up" style="width: 16px; height: 16px; vertical-align: middle;"></i> Presupuesto</a>
                <a href="/analysis" class="nav-link"><i data-lucide="bar-chart-3" style="width: 16px; height: 16px; vertical-align: middle;"></i> An√°lisis</a>
                <a href="/settings" class="nav-link"><i data-lucide="settings" style="width: 16px; height: 16px; vertical-align: middle;"></i> Configuraci√≥n</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üí≥ Gesti√≥n de Transacciones</h2>
            </div>
            <div id="transactions-list" 
                 hx-get="/transactions/list?limit=50"
                 hx-trigger="load, transactionAdded from:body">
                <p class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                    <span class="spinner" style="width: 2rem; height: 2rem; margin: 0 auto; display: block;"></span>
                    <br>Cargando transacciones...
                </p>
            </div>
        </div>
    </div>

    <!-- Panel Lateral Quick Add -->
    <div id="quick-add-panel" class="quick-add-panel">
        <div class="quick-add-header">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;">‚ö° Agregar R√°pido</h3>
            <button class="btn-icon" onclick="toggleQuickAdd()" title="Cerrar">
                <i data-lucide="x" style="width: 20px; height: 20px;"></i>
            </button>
        </div>
        <form id="quick-add-form" class="quick-add-form">
            <div class="form-group-compact">
                <label class="form-label-compact">Tipo</label>
                <select name="type" class="form-select-compact" required
                        hx-get="/categories/by-type"
                        hx-target="#quick-category-select"
                        hx-include="this"
                        hx-trigger="change">
                    <option value="expense" selected>Gasto</option>
                    <option value="income">Ingreso</option>
                    <option value="saving">Ahorro</option>
                </select>
            </div>
            <div class="form-group-compact">
                <label class="form-label-compact">Monto</label>
                <input type="number" name="amount" step="0.01" class="form-input-compact" required placeholder="0.00" autofocus>
            </div>
            <div class="form-group-compact">
                <label class="form-label-compact">Categor√≠a</label>
                <select id="quick-category-select" name="category_id" class="form-select-compact" required
                        hx-get="/categories/by-type?type=expense"
                        hx-trigger="load"
                        hx-swap="innerHTML">
                    <option value="">Cargando...</option>
                </select>
            </div>
            <div class="form-group-compact">
                <label class="form-label-compact">Cuenta</label>
                <select name="account_id" class="form-select-compact" required
                        hx-get="/accounts/select"
                        hx-trigger="load"
                        hx-swap="innerHTML">
                    <option value="">Cargando...</option>
                </select>
            </div>
            <div class="form-group-compact">
                <label class="form-label-compact">Fecha</label>
                <input type="date" name="date" class="form-input-compact" required>
            </div>
            <div class="form-group-compact">
                <label class="form-label-compact">Descripci√≥n</label>
                <input type="text" name="description" class="form-input-compact" placeholder="Opcional">
            </div>
            <button type="button" class="btn btn-primary" style="width: 100%; margin-top: 0.5rem;" onclick="submitQuickAdd()">
                <i data-lucide="check" style="width: 16px; height: 16px; vertical-align: middle;"></i> Guardar
            </button>
        </form>
    </div>
    
    <!-- Overlay para cerrar panel -->
    <div id="quick-add-overlay" class="quick-add-overlay" onclick="toggleQuickAdd()"></div>

    <!-- Modal Nueva Transacci√≥n -->
    <div id="transaction-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; font-weight: 700;">üí∏ Nueva Transacci√≥n</h2>
                <button class="modal-close" onclick="closeTransactionModal()">&times;</button>
            </div>
            <form id="transaction-form">
                <input type="hidden" id="transaction-id" name="transaction_id" value="">
                <div class="form-group">
                    <label class="form-label">üíº Tipo de Transacci√≥n</label>
                    <select id="transaction-type" name="type" class="form-select" required
                            hx-get="/categories/by-type"
                            hx-target="#category-select"
                            hx-include="this"
                            hx-trigger="change">
                        <option value="income">üíö Ingreso</option>
                        <option value="expense" selected>üí∏ Gasto</option>
                        <option value="saving">üè¶ Ahorro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">üè∑Ô∏è Categor√≠a</label>
                    <select id="category-select" name="category_id" class="form-select" required
                            hx-get="/categories/by-type?type=expense"
                            hx-trigger="load"
                            hx-swap="innerHTML">
                        <option value="">Cargando categor√≠as...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">üí≥ Cuenta</label>
                    <select id="account-select" name="account_id" class="form-select" required
                            hx-get="/accounts/select"
                            hx-trigger="load"
                            hx-swap="innerHTML">
                        <option value="">Cargando cuentas...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">üí∞ Monto</label>
                    <input type="number" name="amount" step="0.01" class="form-input" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label">üìÖ Fecha</label>
                    <input type="date" name="date" class="form-input" required>
                </div>
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const today = new Date().toISOString().split('T')[0];
                        document.querySelector('input[name="date"]').value = today;
                    });
                </script>
                <div class="form-group">
                    <label class="form-label">üìù Descripci√≥n</label>
                    <input type="text" name="description" class="form-input" placeholder="Opcional">
                </div>
                <div class="form-group">
                    <label class="form-label">‚úÖ Estado</label>
                    <select name="status" class="form-select">
                        <option value="completed" selected>‚úÖ Completado</option>
                        <option value="pending">‚è≥ Pendiente</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 2rem;">
                    <button type="button" id="delete-transaction-btn" class="btn btn-danger" onclick="deleteTransactionFromModal()" style="display: none;">
                        <i data-lucide="trash-2" style="width: 16px; height: 16px; vertical-align: middle;"></i> Eliminar
                    </button>
                    <div style="display: flex; gap: 1rem; margin-left: auto;">
                        <button type="button" class="btn" onclick="closeTransactionModal()" style="background: #e2e8f0; color: #475569;">‚ùå Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="submitTransaction()">üíæ Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Quick Add Panel
        function toggleQuickAdd() {
            const panel = document.getElementById('quick-add-panel');
            const overlay = document.getElementById('quick-add-overlay');
            panel.classList.toggle('active');
            overlay.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                // Reset form y setear fecha de hoy
                const form = document.getElementById('quick-add-form');
                form.reset();
                const today = new Date().toISOString().split('T')[0];
                form.querySelector('[name="date"]').value = today;
                // Focus en el monto
                setTimeout(() => form.querySelector('[name="amount"]').focus(), 100);
                lucide.createIcons();
            }
        }
        
        async function submitQuickAdd() {
            const form = document.getElementById('quick-add-form');
            
            // Validar campos requeridos
            const categoryId = form.querySelector('[name="category_id"]').value;
            const accountId = form.querySelector('[name="account_id"]').value;
            const amount = form.querySelector('[name="amount"]').value;
            const date = form.querySelector('[name="date"]').value;
            
            if (!categoryId || !accountId || !amount || !date) {
                alert('Por favor completa todos los campos requeridos');
                return;
            }
            
            // Recopilar datos
            const formData = {
                type: form.querySelector('[name="type"]').value,
                category_id: parseInt(categoryId),
                account_id: parseInt(accountId),
                amount: parseFloat(amount),
                currency: 'PEN',
                date: date,
                description: form.querySelector('[name="description"]').value || '',
                status: 'completed'  // Siempre completado en quick add
            };
            
            try {
                const response = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    // Limpiar formulario y mantener abierto para siguiente ingreso
                    form.reset();
                    const today = new Date().toISOString().split('T')[0];
                    form.querySelector('[name="date"]').value = today;
                    form.querySelector('[name="amount"]').focus();
                    
                    // Actualizar lista
                    htmx.trigger('body', 'transactionAdded');
                } else {
                    const error = await response.json();
                    alert('Error al guardar: ' + (error.detail || JSON.stringify(error)));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar la transacci√≥n: ' + error.message);
            }
        }
        
        async function submitTransaction() {
            const form = document.getElementById('transaction-form');
            const transactionId = document.getElementById('transaction-id').value;
            
            // Obtener el tipo de transacci√≥n del select
            const typeSelect = document.getElementById('transaction-type');
            const type = typeSelect.value;
            
            console.log('Type select element:', typeSelect);
            console.log('Type value:', type);
            console.log('Type selected option:', typeSelect.options[typeSelect.selectedIndex]);
            
            // Validar campos requeridos
            const categoryId = form.querySelector('[name="category_id"]').value;
            const accountId = form.querySelector('[name="account_id"]').value;
            const amount = form.querySelector('[name="amount"]').value;
            const date = form.querySelector('[name="date"]').value;
            
            if (!categoryId || !accountId || !amount || !date || !type) {
                alert('Por favor completa todos los campos requeridos');
                return;
            }
            
            // Validar que el tipo sea v√°lido
            if (!['income', 'expense', 'saving'].includes(type)) {
                console.error('Tipo inv√°lido detectado:', type);
                alert('Error: Tipo de transacci√≥n inv√°lido. Por favor recarga la p√°gina.');
                return;
            }
            
            // Recopilar datos del formulario
            const formData = {
                type: type,
                category_id: parseInt(categoryId),
                account_id: parseInt(accountId),
                amount: parseFloat(amount),
                currency: 'PEN',  // Por defecto en soles
                date: date,
                description: form.querySelector('[name="description"]').value || '',
                notes: null,  // Campo requerido por el schema
                status: form.querySelector('[name="status"]').value
            };
            
            console.log('Enviando datos:', formData);
            console.log('JSON string:', JSON.stringify(formData));
            
            try {
                let response;
                if (transactionId) {
                    // Editar (PUT)
                    console.log('Editando transacci√≥n ID:', transactionId);
                    response = await fetch(`/api/transactions/${transactionId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Crear (POST)
                    console.log('Creando nueva transacci√≥n');
                    response = await fetch('/api/transactions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                }
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Guardado exitoso:', result);
                    closeTransactionModal();
                    htmx.trigger('body', 'transactionAdded');
                } else {
                    // Intentar parsear como JSON primero
                    const contentType = response.headers.get('content-type');
                    let errorMessage;
                    
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        console.error('Error del servidor (JSON):', error);
                        errorMessage = error.detail || JSON.stringify(error);
                    } else {
                        // Si no es JSON, leer como texto
                        const errorText = await response.text();
                        console.error('Error del servidor (texto):', errorText);
                        errorMessage = errorText.substring(0, 200); // Primeros 200 caracteres
                    }
                    
                    alert('Error al guardar: ' + errorMessage);
                }
            } catch (error) {
                console.error('Error en la petici√≥n:', error);
                alert('Error al guardar la transacci√≥n: ' + error.message);
            }
        }
        
        function openTransactionModal() {
            document.getElementById('transaction-modal').classList.add('active');
            document.querySelector('#transaction-modal h2').innerHTML = 'üí∏ Nueva Transacci√≥n';
            
            const form = document.getElementById('transaction-form');
            form.reset();
            document.getElementById('transaction-id').value = '';
            
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="date"]').value = today;
        }
        
        function closeTransactionModal() {
            document.getElementById('transaction-modal').classList.remove('active');
            const form = document.querySelector('#transaction-modal form');
            form.reset();
            const today = new Date().toISOString().split('T')[0];
            form.querySelector('input[name="date"]').value = today;
            // Ocultar bot√≥n de eliminar
            document.getElementById('delete-transaction-btn').style.display = 'none';
            // Restaurar t√≠tulo
            document.querySelector('#transaction-modal h2').innerHTML = '‚ûï Nueva Transacci√≥n';
        }

        async function editTransaction(id) {
            try {
                console.log('Cargando transacci√≥n ID:', id);
                const response = await fetch(`/api/transactions/${id}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const transaction = await response.json();
                console.log('Transacci√≥n cargada:', transaction);
                
                // Abrir modal y cambiar t√≠tulo
                document.getElementById('transaction-modal').classList.add('active');
                document.querySelector('#transaction-modal h2').innerHTML = '‚úèÔ∏è Editar Transacci√≥n';
                
                // Mostrar bot√≥n de eliminar
                document.getElementById('delete-transaction-btn').style.display = 'block';
                
                // Guardar el ID de la transacci√≥n
                document.getElementById('transaction-id').value = id;
                
                // Llenar el formulario
                const form = document.getElementById('transaction-form');
                
                // Llenar el tipo primero usando el ID espec√≠fico
                const typeSelect = document.getElementById('transaction-type');
                typeSelect.value = transaction.type;
                
                console.log('Tipo de transacci√≥n cargado:', transaction.type);
                console.log('Valor del select despu√©s de asignar:', typeSelect.value);
                
                // Trigger change para cargar categor√≠as del tipo correcto
                htmx.trigger(typeSelect, 'change');
                
                // Esperar un poco para que carguen las categor√≠as y cuentas
                setTimeout(() => {
                    const categorySelect = form.querySelector('[name="category_id"]');
                    const accountSelect = form.querySelector('[name="account_id"]');
                    
                    if (categorySelect) categorySelect.value = transaction.category_id;
                    if (accountSelect) accountSelect.value = transaction.account_id;
                    
                    form.querySelector('[name="amount"]').value = transaction.amount;
                    form.querySelector('[name="date"]').value = transaction.date;
                    form.querySelector('[name="description"]').value = transaction.description || '';
                    form.querySelector('[name="status"]').value = transaction.status;
                    
                    // Verificar que el tipo no se haya modificado
                    console.log('Valor del tipo despu√©s del timeout:', typeSelect.value);
                    
                    console.log('Formulario llenado con datos');
                }, 500);
                
            } catch (error) {
                console.error('Error cargando transacci√≥n:', error);
                alert('Error al cargar la transacci√≥n: ' + error.message);
            }
        }

        async function deleteTransaction(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta transacci√≥n?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/transactions/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    htmx.trigger('body', 'transactionAdded');
                } else {
                    alert('Error al eliminar la transacci√≥n');
                }
            } catch (error) {
                console.error('Error eliminando transacci√≥n:', error);
                alert('Error al eliminar la transacci√≥n');
            }
        }
        
        async function deleteTransactionFromModal() {
            const transactionId = document.getElementById('transaction-id').value;
            if (!transactionId) {
                alert('No hay transacci√≥n para eliminar');
                return;
            }
            
            if (!confirm('¬øEst√°s seguro de eliminar esta transacci√≥n?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/transactions/${transactionId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    closeTransactionModal();
                    htmx.trigger('body', 'transactionAdded');
                } else {
                    alert('Error al eliminar la transacci√≥n');
                }
            } catch (error) {
                console.error('Error eliminando transacci√≥n:', error);
                alert('Error al eliminar la transacci√≥n');
            }
        }

        document.getElementById('transaction-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTransactionModal();
            }
        });
        
        // Quick Add Row Functions
        async function loadQuickCategories(type) {
            try {
                const response = await fetch(`/api/categories?type=${type}`);
                const categories = await response.json();
                
                const categorySelect = document.getElementById('quick-category');
                categorySelect.innerHTML = categories.map(c => 
                    `<option value="${c.id}">${c.name}</option>`
                ).join('');
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        async function saveQuickTransaction() {
            const date = document.getElementById('quick-date').value;
            const type = document.getElementById('quick-type').value;
            const categoryId = document.getElementById('quick-category').value;
            const accountId = document.getElementById('quick-account').value;
            const amount = document.getElementById('quick-amount').value;
            const description = document.getElementById('quick-description').value;
            
            if (!date || !categoryId || !accountId || !amount) {
                alert('Por favor completa los campos requeridos');
                return;
            }
            
            try {
                const response = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: type,
                        category_id: parseInt(categoryId),
                        account_id: parseInt(accountId),
                        amount: parseFloat(amount),
                        currency: 'PEN',
                        date: date,
                        description: description || '',
                        status: 'completed'
                    })
                });
                
                if (response.ok) {
                    // Limpiar formulario
                    document.getElementById('quick-amount').value = '';
                    document.getElementById('quick-description').value = '';
                    document.getElementById('quick-date').value = new Date().toISOString().split('T')[0];
                    
                    // Refocus en monto
                    document.getElementById('quick-amount').focus();
                    
                    // Actualizar lista
                    htmx.trigger('body', 'transactionAdded');
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar');
            }
        }
        
        // Enter key handler para quick add row
        document.addEventListener('DOMContentLoaded', function() {
            const quickRow = document.getElementById('quick-add-row');
            if (quickRow) {
                quickRow.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.target.tagName !== 'BUTTON') {
                        e.preventDefault();
                        saveQuickTransaction();
                    }
                });
                
                // Autofocus en amount al cargar
                setTimeout(() => {
                    const amountInput = document.getElementById('quick-amount');
                    if (amountInput) amountInput.focus();
                }, 100);
            }
        });

        // Sistema de temas
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            
            if (savedTheme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                html.setAttribute('data-theme', savedTheme);
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (localStorage.getItem('theme') === 'auto') {
                    html.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                }
            });
        })();
    </script>
    <script>
        // Inicializar iconos de Lucide cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
        
        // Re-inicializar iconos despu√©s de cambios HTMX
        document.body.addEventListener('htmx:afterSwap', function() {
            lucide.createIcons();
        });
        
        document.body.addEventListener('htmx:afterSettle', function() {
            lucide.createIcons();
        });
    </script>
</body>
</html>

